(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{"2wwy":function(e,t,n){e.exports=n("nhzr")},"9Jkg":function(e,t,n){e.exports=n("oh+g")},E8gZ:function(e,t,n){var l=n("w6GO"),a=n("NsO/"),o=n("NV0k").f;e.exports=function(e){return function(t){for(var n,r=a(t),c=l(r),i=c.length,s=0,u=[];i>s;)o.call(r,n=c[s++])&&u.push(e?[n,r[n]]:r[n]);return u}}},RNiq:function(e,t,n){"use strict";n.r(t);var l=n("pLtp"),a=n.n(l),o=n("ln6h"),r=n.n(o),c=n("O40h"),i=n("UXZV"),s=n.n(i),u=n("2wwy"),h=n.n(u),f=n("0iUn"),p=n("sLSF"),d=n("MI3g"),g=n("a7VT"),v=n("AT/M"),m=n("Tit0"),y=n("hfKm"),b=n.n(y);function w(e,t,n){return t in e?b()(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var I=n("9Jkg"),O=n.n(I),C=n("q1tI"),j=n.n(C),x=n("PgRs"),k=n.n(x);n.d(t,"default",function(){return q});var E=!0,S="metanear-dev-001",A="cell:",W="cellInfo:",M="Meta NEAR",N="https://cdn.jsdelivr.net/gh/nearprotocol/nearcore@master/nearlib/dist/nearlib.js",H="https://cdn.jsdelivr.net/npm/nearlib@0.4.7/dist/nearlib.js",T=function(e){return O()(e)},U=function(e){return T(e.location)},R=[],P=function(e,t,n){return e*e+t*t<=n*n},J=function(e){if(0==R.length)for(var t=-7;t<=7;++t)for(var n=-7;n<=7;++n)P(n,t,7)&&R.push({dx:n,dy:t});return R[e]},L=function(e){function t(){var e,n;Object(f.default)(this,t);for(var l=arguments.length,a=new Array(l),o=0;o<l;o++)a[o]=arguments[o];return n=Object(d.default)(this,(e=Object(g.default)(t)).call.apply(e,[this].concat(a))),w(Object(v.default)(n),"onMouseMove",function(e){var t=n.props.width/2-n.props.cellWidth/2,l=n.props.height/2-n.props.cellHeight/2;n.props.onHighlight(Math.floor((e.offsetX-t)/n.props.cellWidth)+n.props.playerX,Math.floor((e.offsetY-l)/n.props.cellHeight)+n.props.playerY)}),n}return Object(m.default)(t,e),Object(p.default)(t,[{key:"componentDidUpdate",value:function(e,t,n){var l=this,a=this.refs.canvas.getContext("2d");a.clearRect(0,0,this.props.width,this.props.height),a.fillStyle="#FF0000";for(var o=this.props.width/2-this.props.cellWidth/2,r=this.props.height/2-this.props.cellHeight/2,c=this.props.width/this.props.cellWidth,i=this.props.height/this.props.cellHeight,s=-c/2;s<c/2;++s)a.beginPath(),a.moveTo(o+s*this.props.cellWidth,0),a.lineTo(o+s*this.props.cellWidth,this.props.height),a.stroke();for(var u=-i;u<i;++u)a.beginPath(),a.moveTo(0,r+(u-.7)*this.props.cellHeight),a.lineTo(this.props.width,r+(u-.7)*this.props.cellHeight),a.stroke();var f=function(e){return{x:o+e.dx*l.props.cellWidth,y:r+e.dy*l.props.cellHeight,width:l.props.cellWidth,height:l.props.cellHeight}},p=function(e,t){if(t){var n=l.props.images[t];return!!n&&(a.drawImage(n,0,0,n.width,n.height,e.x,e.y,e.width,e.height),!0)}};h()(this.props.allCells).forEach(function(e){var t,n=l.props.cellInfos[e.cellId],o={dx:(t=e.location).x-l.props.playerX,dy:t.y-l.props.playerY},r=f(o);n&&p(r,n.imageUrl)||(a.fillStyle="rgba(64, 0, 0, 1.0)",a.fillRect(r.x,r.y,r.width,r.height)),P(o.dx,o.dy,7)||(a.fillStyle="rgba(0, 0, 0, 0.5)",a.fillRect(r.x,r.y,r.width,r.height))}),p(f({dx:0,dy:0}),"/static/imgs/player.png"),document.addEventListener("mousemove",this.onMouseMove,!1)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("mousemove",this.onMouseMove,!1)}},{key:"render",value:function(){return j.a.createElement("canvas",{ref:"canvas",width:this.props.width,height:this.props.height,onClick:this.props.onClick})}}]),t}(j.a.Component),X=function(e){function t(){return Object(f.default)(this,t),Object(d.default)(this,Object(g.default)(t).apply(this,arguments))}return Object(m.default)(t,e),Object(p.default)(t,[{key:"render",value:function(){return j.a.createElement("div",{id:"sign-in-container"},j.a.createElement("h2",null," Hello stranger! Who are you?"),j.a.createElement("div",{id:"login-form"},j.a.createElement("div",{className:"col-md-4"},j.a.createElement("button",{onClick:this.props.onClick,id:"login-button",className:"btn btn-lg btn-block btn-primary"},"Login with NEAR Wallet"))))}}]),t}(j.a.Component),V=function(e){function t(){return Object(f.default)(this,t),Object(d.default)(this,Object(g.default)(t).apply(this,arguments))}return Object(m.default)(t,e),Object(p.default)(t,[{key:"render",value:function(){return j.a.createElement("div",{id:"hello"},j.a.createElement("h2",{id:"hello"},"Hi, ",this.props.accountId,"!"))}}]),t}(j.a.Component),_=function(e){function t(){return Object(f.default)(this,t),Object(d.default)(this,Object(g.default)(t).apply(this,arguments))}return Object(m.default)(t,e),Object(p.default)(t,[{key:"render",value:function(){return j.a.createElement("iframe",{src:this.props.url,width:640,height:480})}}]),t}(j.a.Component),Y=function(e){function t(e){var n;return Object(f.default)(this,t),n=Object(d.default)(this,Object(g.default)(t).call(this,e)),w(Object(v.default)(n),"fetchImage",function(e){if(!(e in n.fetchingImages)){n.fetchingImages[e]=!0;var t=new Image(32,32);t.onload=function(){var l={};l[e]=t,n.setState({images:s()(n.state.images,l)})},t.src=e}}),w(Object(v.default)(n),"addCellInfo",function(e,t){t.cellId=e;var l={};l[e]=t,localStorage.setItem(W+e,O()(t)),t.imageUrl&&n.fetchImage(t.imageUrl),n.setState({cellInfos:s()(n.state.cellInfos,l)})}),w(Object(v.default)(n),"checkCellInfo",function(e){e in n.fetchingCellInfos||(n.fetchingCellInfos[e]=!0,n.contract.getCellInfo({cellId:e}).then(function(t){return n.addCellInfo(e,t)}).catch(function(t){console.log(t),n.fetchingCellInfos[e]=null}))}),w(Object(v.default)(n),"updateView",function(e){var t={},l=s()({},n.state.player,{location:e.location});e.cellIds&&e.cellIds.forEach(function(l,a){var o={location:{x:e.location.x+J(a).dx,y:e.location.y+J(a).dy},cellId:l};n.checkCellInfo(l),t[U(o)]=o,localStorage.setItem(A+U(o),O()(o))}),n.setState({player:l,allCells:s()(n.state.allCells,t)})}),w(Object(v.default)(n),"fetchCells",Object(c.default)(r.a.mark(function e(){var t,l;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.state.player?n.state.player.accountId:"metanear",e.next=3,n.contract.lookAround({accountId:t});case 3:l=e.sent,n.updateView(l);case 5:case"end":return e.stop()}},e)}))),w(Object(v.default)(n),"nearConnect",Object(c.default)(r.a.mark(function e(){var t,l,a,o;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!E){e.next=6;break}n.walletAccount=new nearlib.WalletAccount(S,"https://wallet.nearprotocol.com/"),l=n.walletAccount.getAccountId(),t=new nearlib.Near(new nearlib.NearClient(n.walletAccount,new nearlib.LocalNodeConnection("https://studio.nearprotocol.com/devnet"))),e.next=12;break;case 6:return a={deps:{createAccount:nearlib.dev.createAccountWithLocalNodeConnection},nodeUrl:"http://localhost:3030"},e.next=9,nearlib.dev.connect(a);case 9:t=e.sent,l=nearlib.dev.myAccountId,n.walletAccount={isSignedIn:function(){return!0},getAccountId:function(){return l}};case 12:return console.log(l),e.next=15,t.loadContract(S,{viewMethods:["lookAround","getPlayer","getCellInfo"],changeMethods:["move","deploy","init"],sender:l});case 15:if(n.contract=e.sent,window.contract=n.contract,!l){e.next=23;break}return e.next=20,n.contract.getPlayer({accountId:l});case 20:o=e.sent,console.log(o),n.setState({player:o});case 23:return e.next=25,n.fetchCells();case 25:case"end":return e.stop()}},e)}))),w(Object(v.default)(n),"onHighlight",function(e,t){var l=n.state.allCells[T({x:e,y:t})]||{};n.setState({highlightCell:l,canMoveThere:n.canMove(e,t)})}),w(Object(v.default)(n),"login",function(){n.walletAccount.requestSignIn(S,M)}),w(Object(v.default)(n),"logout",function(){}),w(Object(v.default)(n),"canMove",function(e,t){if(!n.state.player)return!1;var l=e-n.state.player.location.x,a=t-n.state.player.location.y;return P(l,a,7)}),w(Object(v.default)(n),"movePlayer",function(){if(n.state.canMoveThere&&n.state.highlightCell.location){var e=n.state.highlightCell.location.x-n.state.player.location.x,t=n.state.highlightCell.location.y-n.state.player.location.y;n.contract.move({dx:e,dy:t}).then(function(e){return n.updateView(e.lastResult)})}}),n.state={allCells:{},highlightCell:{},images:{},canMoveThere:!1,player:null,cellInfos:{}},n.fetchingImages={},n.fetchingCellInfos={},n.walletAccount=null,n}return Object(m.default)(t,e),Object(p.default)(t,[{key:"componentDidMount",value:function(){var e=this,t={},n={};a()(localStorage).forEach(function(l){if(l.startsWith(A))try{var a=JSON.parse(localStorage.getItem(l));A+U(a)==l&&(t[U(a)]=a)}catch(r){}else if(l.startsWith(W))try{var o=JSON.parse(localStorage.getItem(l));W+o.cellId==l&&(o.imageUrl&&e.fetchImage(o.imageUrl),n[o.cellId]=o)}catch(r){}}),this.setState({allCells:t,cellInfos:n}),this.fetchImage("/static/imgs/player.png"),this.nearConnect()}},{key:"render",value:function(){var e;e=this.walletAccount&&this.walletAccount.isSignedIn()?j.a.createElement(V,{accountId:this.walletAccount.getAccountId(),onClick:this.logout}):j.a.createElement(X,{onClick:this.login});var t=null;if(this.state.player){var n=this.state.allCells[T(this.state.player.location)];if(n){var l=n.cellId;t=this.state.cellInfos[l]}}return j.a.createElement("div",null,e,j.a.createElement(L,{width:640,height:425,cellWidth:32,cellHeight:32,allCells:this.state.allCells,onHighlight:this.onHighlight,images:this.state.images,cellInfos:this.state.cellInfos,playerX:this.state.player&&this.state.player.location.x,playerY:this.state.player&&this.state.player.location.y,onClick:this.movePlayer}),j.a.createElement("div",null,"Highlighted cell: ",O()(this.state.highlightCell)),j.a.createElement("div",null,"Player: ",O()(this.state.player)),t&&t.webUrl&&j.a.createElement(_,{url:t.webUrl,contractId:t.contractId}))}}]),t}(j.a.Component);function q(){return j.a.createElement("div",null,j.a.createElement(k.a,null,j.a.createElement("script",{src:E?H:N})),j.a.createElement("div",null,j.a.createElement(Y,null)))}},fW1p:function(e,t,n){var l=n("Y7ZC"),a=n("E8gZ")(!1);l(l.S,"Object",{values:function(e){return a(e)}})},nhzr:function(e,t,n){n("fW1p"),e.exports=n("WEpk").Object.values},"oh+g":function(e,t,n){var l=n("WEpk"),a=l.JSON||(l.JSON={stringify:JSON.stringify});e.exports=function(e){return a.stringify.apply(a,arguments)}},vlRD:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){var e=n("RNiq");return{page:e.default||e}}])}},[["vlRD",1,0]]]);