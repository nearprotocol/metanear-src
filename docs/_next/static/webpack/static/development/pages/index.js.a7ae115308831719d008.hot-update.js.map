{"version":3,"file":"static/webpack/static/development/pages/index.js.a7ae115308831719d008.hot-update.js","sources":["webpack:///./pages/index.js"],"sourcesContent":["import Component from 'react'\nimport Link from 'next/link'\nimport Head from 'next/head'\n// import { Near } from 'nearlib'\n\nconst contractId = \"metanear\";\nconst appTitle = \"Meta NEAR\"\nconst baseUrl = \"http://localhost:3000\"\n\nconst locationKey = (location) => JSON.stringify(location)\nconst cellKey = (cell) => locationKey(cell.location)\n\nclass Grid extends React.Component {\n    componentDidUpdate(prevProps, prevState, snapshot) {\n        const canvas = this.refs.canvas\n        const ctx = canvas.getContext(\"2d\")\n        ctx.clearRect(0, 0, this.props.width, this.props.height);\n        ctx.fillStyle = \"#FF0000\";\n        const centerX = this.props.width / 2 - this.props.cellWidth / 2\n        const centerY = this.props.height / 2 - this.props.cellHeight / 2\n        const cellNumberX = this.props.width / this.props.cellWidth\n        const cellNumberY = this.props.height / this.props.cellHeight\n        for (let i =  - cellNumberX / 2; i < cellNumberX / 2; ++i) {\n            ctx.beginPath()\n            ctx.moveTo(centerX + i * this.props.cellWidth, 0)\n            ctx.lineTo(centerX + i * this.props.cellWidth, this.props.height)\n            ctx.stroke()\n        }\n        for (let i = - cellNumberY; i < cellNumberY; ++i) {\n            ctx.beginPath()\n            ctx.moveTo(0, centerY + (i - 0.6) * this.props.cellHeight)\n            ctx.lineTo(this.props.width, centerY + (i - 0.6) * this.props.cellHeight)\n            ctx.stroke()\n        }\n        Object.values(this.props.allCells).forEach((cell) => {\n            ctx.fillStyle = [\"#AA6666\", \"#AAAA66\", \"#AA66AA\", \"#6666AA\", \"#333333\"][cell.viewIndex]\n            ctx.fillRect(\n                centerX + (cell.location.x - this.props.playerX) * this.props.cellWidth,\n                centerY + (cell.location.y - this.props.playerY) * this.props.cellHeight,\n                this.props.cellWidth,\n                this.props.cellHeight)\n        })\n        Object.values(this.props.cells).forEach((cell) => {\n            ctx.fillStyle = [\"#FF9999\", \"#FFFF99\", \"#FF99FF\", \"#9999FF\", \"#666666\"][cell.viewIndex]\n            ctx.fillRect(\n                centerX + (cell.location.x - this.props.playerX) * this.props.cellWidth,\n                centerY + (cell.location.y - this.props.playerY) * this.props.cellHeight,\n                this.props.cellWidth,\n                this.props.cellHeight)\n        })\n        ctx.beginPath()\n        ctx.arc(centerX + (0.5) * this.props.cellWidth, centerY + (0.5) * this.props.cellHeight, this.props.cellWidth / 2 - 3, 0, 2 * Math.PI)\n        ctx.stroke()\n        document.addEventListener('mousemove', this.onMouseMove, false)\n    }\n    componentWillUnmount() {\n        document.removeEventListener('mousemove', this.onMouseMove, false)\n    }\n    onMouseMove = (e) => {\n        this.props.onHighlight(Math.floor(e.offsetX / this.props.cellWidth), Math.floor(e.offsetY / this.props.cellHeight))\n    }\n    render() {\n        return (\n            <canvas ref=\"canvas\" width={this.props.width} height={this.props.height} onClick={this.props.onClick} />\n        )\n    }\n}\n\nclass WalletLogin extends React.Component {\n    render() {\n        return (\n            <div id=\"sign-in-container\">\n                <h2> Hello stranger! Who are you?</h2>\n                <div id=\"login-form\">\n                    <div className=\"col-md-4\"><button onClick={this.props.onClick} id=\"login-button\" className=\"btn btn-lg btn-block btn-primary\">Login with NEAR Wallet</button></div>\n                </div>\n            </div> \n        )\n    }\n}\n\nclass WalletLogout extends React.Component {\n    render() {\n        return (\n            <div id=\"hello\">\n                <h2 id=\"hello\">Hi, {this.props.accountId}!</h2>\n            </div>\n        )\n    }\n}\n\nclass MiniGameView extends React.Component {\n    render() {\n        return (\n            <iframe src={this.props.url} width={640} height={480}/>\n        )\n    }\n}\n\nclass Game extends React.Component {\n    constructor(props) {\n        super(props)\n        this.state = { \n            cells: {},\n            allCells: {},\n            highlighCell: {},\n            player: null\n        }\n        this.walletAccount = null\n    }\n    fetchCells = async(accountId) => {\n        let view = await this.contract.lookAround({ accountId })\n        console.log(view)\n        let cells = {}\n        if (view.cells) {\n            view.cells.forEach((cell) => {\n                cells[cellKey(cell)] = cell;\n            });\n        }\n        this.setState({ cells, allCells: Object.assign(this.state.allCells, cells) })\n    }\n    nearConnect = async () => {\n        this.walletAccount = new nearlib.WalletAccount(contractId, \"https://wallet.nearprotocol.com/\");\n        const accountId = this.walletAccount.getAccountId();\n        console.log(accountId)\n        const near = new nearlib.Near(new nearlib.NearClient(\n            this.walletAccount,\n            new nearlib.LocalNodeConnection(\"https://studio.nearprotocol.com/devnet\"),\n        ));\n        this.contract = await near.loadContract(contractId, {\n            viewMethods: [\"lookAround\", \"getPlayer\"],\n            changeMethods: [\"move\", \"deploy\"],\n            sender: accountId,\n        });\n        window.contract = this.contract\n        await this.fetchCells(accountId)\n        if (accountId) {\n            let player = await this.contract.getPlayer({ accountId })\n            console.log(player)\n            this.setState({player})\n        }\n    }\n    componentDidMount() {\n        this.nearConnect();\n    }\n    onHighlight = (x, y) => {\n        let highlighCell = this.state.allCells[locationKey({x, y})] || {}\n        this.setState({highlighCell})\n    }\n    login = () => {\n        this.walletAccount.requestSignIn(\n            contractId,\n            appTitle,\n            baseUrl + '/',\n            baseUrl + '/',\n        );\n    }\n    logout = () => {\n\n    }\n    movePlayer = () => {\n        let dx = 0\n        let dy = 0\n        if (Math.abs(this.state.player.location.x - this.state.highlighCell.location.x) == 1) {\n            dx = this.state.player.location.x > this.state.highlighCell.location.x ? -1 : 1\n        } else if (Math.abs(this.state.player.location.y - this.state.highlighCell.location.y) == 1) {\n            dy = this.state.player.location.y > this.state.highlighCell.location.y ? -1 : 1\n        }\n        this.contract.move({dx, dy}).then(() => {\n            const accountId = this.walletAccount.getAccountId();\n            this.contract.getPlayer({ accountId }).then(async (player) => {\n                console.log(player)\n                this.setState({ player })\n                await this.fetchCells(accountId)\n            })\n        })\n    }\n    render() {\n        let control;\n        if (this.walletAccount && this.walletAccount.isSignedIn()) {\n            control = <WalletLogout accountId={this.walletAccount.getAccountId()} onClick={this.logout} />\n        } else {\n            control = <WalletLogin onClick={this.login} />\n        }\n        let cell = null;\n        if (this.state.player) {\n            cell = this.state.cells[locationKey(this.state.player.location)];\n        }\n        return (\n            <div>\n                {control}\n                <Grid width={640} height={425} cellWidth={20} cellHeight={20} \n                cells={this.state.cells} allCells={this.state.allCells} onHighlight={this.onHighlight}\n                    playerX={this.state.player && this.state.player.location.x} \n                    playerY={this.state.player && this.state.player.location.y} \n                onClick={this.movePlayer} />\n                <div>Highlighted cell: {JSON.stringify(this.state.highlighCell)}</div>\n                <div>Player: {JSON.stringify(this.state.player)}</div>\n                {cell && <MiniGameView url={cell.webUrl} contractId={cell.contractId} />}\n            </div>\n        )\n    }\n}\n\nexport default function Index() {\n    return (\n        <div>\n            <Head>\n                <script src=\"https://cdn.jsdelivr.net/npm/nearlib@0.4.2/dist/nearlib.js\"></script>\n            </Head>\n            <div>\n                <Game />\n            </div>\n        </div>\n    )\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;;;;;;AA8CA;AACA;AACA;AACA;;;;;;AAhDA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAKA;AACA;AAAA;AACA;AACA;AAKA;AACA;AAAA;AACA;AACA;AACA;AACA;;;AACA;AACA;AACA;;;AAIA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;;;;AArDA;AACA;AAuDA;;;;;;;;;;;;;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;;;;AAVA;AACA;AAYA;;;;;;;;;;;;;AACA;AACA;AACA;AAAA;AACA;AAAA;AAGA;;;;AAPA;AACA;AASA;;;;;;;;;;;;;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;;;;AALA;AACA;AAOA;;;;;AACA;AAAA;AACA;AADA;AACA;AAAA;AACA;AAFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;AAFA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAXA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAqBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAJA;AAAA;AASA;AACA;AACA;AAHA;AACA;AATA;AAQA;AAKA;AAbA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAgBA;AAAA;AACA;AAjBA;AAgBA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAtBA;AA8CA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAjDA;AAkDA;AAMA;AACA;AAzDA;AACA;AADA;AA6DA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAHA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAKA;AACA;AACA;AA3EA;AACA;AACA;AACA;AACA;AAJA;AAMA;AARA;AASA;AACA;;;AAgCA;AACA;AACA;;;AAiCA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAJA;AAOA;AAAA;AAAA;AAGA;;;;AAtGA;AACA;AAwGA;AACA;AAGA;AAAA;AAOA;;;;A","sourceRoot":""}